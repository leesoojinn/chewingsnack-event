<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>💜츄잉스낵 이벤트 돌림판💜</title>
  <style>
    body {
      font-family: 'Nanum Gothic', sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
      background: #fdf6ff;
      color: #4b2a7b;
      text-align: center;
    }
    h2 {
      margin-bottom: 25px;
      color: #7d4cc2;
    }
    label, input, button {
      font-size: 1rem;
    }
    input[type=number] {
      padding: 6px 8px;
      width: 140px;
      border: 1px solid #d7b9ff;
      border-radius: 4px;
      margin-right: 10px;
      background: #fff;
    }
    button {
      padding: 8px 16px;
      background: #8e5ed6;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: #6e3dc0;
    }
    button:disabled {
      background: #c7a8ee;
      cursor: not-allowed;
    }

    /* ✅ 반응형: 휠 컨테이너를 화면 폭에 맞춰 자동 축소 */
    #wheelContainer {
      margin: 20px auto;
      position: relative;
      width: 100%;
      max-width: 420px;      /* 데스크톱 상한 */
      aspect-ratio: 1 / 1;   /* 정사각형 유지 */
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #wheel {
      width: 100%;
      height: 100%;
      transition: transform 4s cubic-bezier(0.33, 1, 0.68, 1);
      transform-origin: 50% 50%;
    }

    #spinPointer {
      position: absolute;
      top: -10px;     /* 필요시 모바일에서 미세 조정됨 */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 18px solid transparent;
      border-right: 18px solid transparent;
      border-top: 60px solid #6d33a8; /* 길고 얇은 진보라색 포인터 */
      z-index: 10;
      filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2));
      user-select: none;
      pointer-events: none;
    }

    #resultPanel {
      margin: 20px auto;
      background: #faf3ff;
      padding: 10px;
      border-radius: 8px;
      width: 90%;
      box-shadow: inset 0 0 6px #d1b7ff77;
      color: #4b2a7b;
    }

    #history {
      margin-top: 10px;
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.9rem;
      line-height: 1.4;
      color: #6a3e9e;
    }

    #tierInfo {
      margin-top: 8px;
      color: #7d4cc2;
      font-weight: bold;
    }

    /* 📱 모바일 보조 조정(선택): 폰에서 살짝 더 작게 */
    @media (max-width: 600px){
      input[type=number]{ width: 42vw; font-size:.95rem; }
      button{ padding: 8px 12px; font-size:.95rem; }
      #resultPanel{ font-size:.95rem; }
      /* 포인터도 화면에 비례해 살짝 축소 */
      #spinPointer{
        top: -8px;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-top: 40px solid #6d33a8;
      }
    }
  </style>
</head>
<body>

<h2>💜츄잉스낵 이벤트 돌림판💜</h2>

<div>
  <label for="purchaseAmount">구매금액(원): </label>
  <input type="number" id="purchaseAmount" placeholder="예: 45000" min="0" />
  <button id="applyAmount">적용</button>
  <div id="tierInfo"></div>
</div>

<div id="wheelContainer">
  <div id="wheel"></div>
  <div id="spinPointer"></div>
</div>

<button id="spinBtn" disabled>회전판 돌리기</button>

<div id="resultPanel">
  <div><strong>마지막 당첨 결과: </strong><span id="lastResult">-</span></div>
  <div><strong>남은 횟수: </strong><span id="spinsLeft">0</span></div>
  <div id="history"><strong>히스토리:</strong><br/></div>
</div>

<script>
  const prizes = [
    "고구마칩 토핑용", "오트리얼칩", "바삭파칩",
    "고구마스틱", "구운참마깨스틱", "페스츄리 오징어", "오트밀강정",
    "랜덤 젤리", "바삭파칩", "랜덤 뿔마칩", "고구마칩 토핑용",
    "랜덤 젤리", "랜덤 뿔마칩", "오트리얼칩", "랜덤젤리"
  ];

  const wheel = document.getElementById('wheel');
  const spinBtn = document.getElementById('spinBtn');
  const lastResultSpan = document.getElementById('lastResult');
  const spinsLeftSpan = document.getElementById('spinsLeft');
  const historyDiv = document.getElementById('history');
  const tierInfoDiv = document.getElementById('tierInfo');
  const purchaseAmountInput = document.getElementById('purchaseAmount');
  const applyAmountBtn = document.getElementById('applyAmount');
  const container = document.getElementById('wheelContainer');
  const pointer = document.getElementById('spinPointer');

  let spinsLeft = 0;
  let currentRotation = 0;

  // ✅ 컨테이너 실제 크기에 맞춰 캔버스를 그리는 함수
  function drawWheelResponsive() {
    const rect = container.getBoundingClientRect();
    const size = Math.round(Math.min(rect.width, rect.height)); // 정사각형
    if (!size || size <= 0) return;

    const n = prizes.length;
    const cx = size / 2;

    const canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');

    // 비율 기반 파라미터 (화면에 따라 자동 스케일)
    const R_outer   = cx - 2;
    const ringWidth = Math.max(22, Math.round(size * 0.06));
    const R_wedge   = R_outer - ringWidth;
    const dotR      = Math.max(5, Math.round(size * 0.015));
    const dotCount  = 28;

    const purple     = '#6d33a8';
    const lightPurple= '#bda4f7';
    const pale       = '#e7d9ff';
    const wedgeColors= ['#e9e0fb', '#efe7ff'];
    const lineColor  = '#8a5ed9';

    // 외곽 원
    ctx.beginPath();
    ctx.arc(cx, cx, R_outer, 0, Math.PI * 2);
    ctx.fillStyle = purple;
    ctx.fill();

    // 흰 점 테두리
    for (let i = 0; i < dotCount; i++) {
      const ang = (i / dotCount) * Math.PI * 2;
      const x = cx + Math.cos(ang) * (R_outer - ringWidth/2);
      const y = cx + Math.sin(ang) * (R_outer - ringWidth/2);
      ctx.beginPath();
      ctx.arc(x, y, dotR, 0, Math.PI * 2);
      ctx.fillStyle = '#fff';
      ctx.fill();
    }

    // 섹터
    const anglePer = (2 * Math.PI) / n;
    for (let i = 0; i < n; i++) {
      const a0 = i * anglePer;
      const a1 = (i + 1) * anglePer;

      // 웨지
      ctx.beginPath();
      ctx.moveTo(cx, cx);
      ctx.arc(cx, cx, R_wedge, a0, a1);
      ctx.closePath();
      ctx.fillStyle = wedgeColors[i % 2];
      ctx.fill();

      // 구분선(선명)
      ctx.beginPath();
      ctx.moveTo(cx, cx);
      ctx.lineTo(cx + Math.cos(a0) * R_wedge, cx + Math.sin(a0) * R_wedge);
      ctx.strokeStyle = lineColor;
      ctx.lineWidth = Math.max(1.5, size * 0.004);
      ctx.stroke();

      // 라벨
      ctx.save();
      ctx.translate(cx, cx);
      ctx.rotate(a0 + anglePer / 2);
      ctx.textAlign = 'right';
      ctx.fillStyle = '#4b2a7b';
      ctx.font = `bold ${Math.max(14, Math.round(size * 0.042))}px Nanum Gothic, sans-serif`;
      let t = prizes[i];
      while (ctx.measureText(t).width > (R_wedge - 16) * 0.95 && t.length > 2) t = t.slice(0, -1);
      ctx.fillText(t, R_wedge - 12, 8);
      ctx.restore();
    }

    // 중앙 링
    ctx.beginPath();
    ctx.arc(cx, cx, Math.round(size * 0.17), 0, Math.PI * 2);
    ctx.fillStyle = lightPurple;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cx, Math.round(size * 0.12), 0, Math.PI * 2);
    ctx.fillStyle = pale;
    ctx.fill();

    wheel.innerHTML = '';
    wheel.appendChild(canvas);

    // 🔺 포인터도 화면 비례로 자동 조정
    const bl = Math.round(size * 0.04); // 좌우 두께
    const bt = Math.round(size * 0.12); // 세모 높이
    pointer.style.borderLeft  = `${bl}px solid transparent`;
    pointer.style.borderRight = `${bl}px solid transparent`;
    pointer.style.borderTop   = `${bt}px solid ${purple}`;
    pointer.style.top         = `${-Math.round(size * 0.02)}px`;
  }

  function degreeToSegment(degree) {
    const adjusted = (degree + 90) % 360;
    const anglePer = 360 / prizes.length;
    return (prizes.length - 1 - Math.floor(adjusted / anglePer));
  }

  function spinWheel() {
    if (spinsLeft <= 0) return alert("더 이상 돌릴 수 없습니다!");
    spinBtn.disabled = true;

    const extra = 360 * (5 + Math.random() * 3);
    currentRotation += extra;
    wheel.style.transition = 'transform 4s cubic-bezier(0.33, 1, 0.68, 1)';
    wheel.style.transform = `rotate(${currentRotation}deg)`;

    setTimeout(() => {
      spinBtn.disabled = false;
      spinsLeft--;
      spinsLeftSpan.textContent = spinsLeft;

      const degree = currentRotation % 360;
      const prizeIndex = degreeToSegment(degree);
      const result = prizes[prizeIndex];
      lastResultSpan.textContent = result;

      const now = new Date();
      const record = document.createElement('div');
      record.textContent = `${now.toLocaleTimeString()} - ${result}`;
      historyDiv.appendChild(record);
    }, 4000);
  }

  function determineSpins(amount) {
    if (amount >= 100000) return 5;
    if (amount >= 70000) return 3;
    if (amount >= 50000) return 2;
    if (amount >= 30000) return 1;
    return 0;
  }

  applyAmountBtn.addEventListener('click', () => {
    const amount = Number(purchaseAmountInput.value);
    spinsLeft = determineSpins(amount);
    spinsLeftSpan.textContent = spinsLeft;
    tierInfoDiv.textContent =
      spinsLeft > 0
        ? `구매금액 ${amount.toLocaleString()}원 - ${spinsLeft}회 기회`
        : `3만원 이상 구매시 참여 가능합니다.`;
    spinBtn.disabled = spinsLeft <= 0;
    lastResultSpan.textContent = '-';
    historyDiv.innerHTML = '<strong>히스토리:</strong><br/>';
  });

  spinBtn.addEventListener('click', spinWheel);

  // ✅ 최초 렌더 & 리사이즈 시 재그리기
  window.addEventListener('resize', drawWheelResponsive);
  // 일부 브라우저 초기 레이아웃 후 크기 계산을 위해 한 틱 뒤에 호출
  requestAnimationFrame(drawWheelResponsive);
</script>

</body>
</html>
